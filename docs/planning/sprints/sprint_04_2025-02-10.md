# **Sprint 4: Workout Logging**

Sprint Duration: February 10, 2025 - February 16, 2025
Primary Goal: Implement workout session persistence and logging functionality, enabling users to track their training progress with both plan-based and ad-hoc workouts.

**Sprint Status: TODO (0%)**
- API Endpoint Tasks: 0/4 TODO
- Data Model Tasks: 0/2 TODO
- Business Logic Tasks: 0/3 TODO
- Testing Tasks: 0/2 TODO
- Documentation Tasks: 0/1 TODO
- Total Tasks: 0/12 TODO

## **Sprint Objectives**

1. Enable users to log complete workout sessions with detailed set tracking
2. Support both plan-based workouts (following a pre-defined plan) and ad-hoc workouts
3. Provide comprehensive workout history retrieval with filtering and pagination
4. Calculate and persist workout metrics (volume, duration, RPE)
5. Maintain data integrity with proper relationships between sessions, sets, and exercises

## **Tasks**

This board follows the "Rule of One": Only one item should be in the "IN PROGRESS" section at any time.

### **TODO**

#### Data Model Tasks
* [ ] **Task 1: Define Workout API Contract & Create Models**
  - Description: Define OpenAPI contract FIRST, then create Pydantic models matching the contract
  - User Story: As a developer, I want a contract-driven API with validated data models
  - Dependencies: None
  - Estimated Effort: 3 hours
  - Acceptance Criteria:
    - Define complete OpenAPI contract for all workout endpoints
    - Document request/response shapes in OpenAPI schema first
    - WorkoutSessionCreateModel with plan_id (optional), notes, RPE, wellness fields
    - WorkoutSessionResponseModel with all session data and calculated metrics
    - SetCreateModel for individual set logging (exercise_id, weight, reps, etc.)
    - SetResponseModel with volume calculations
    - Models must match the OpenAPI contract exactly
    - Run `uv run poe generate-openapi` to verify contract
  - Assigned To: api-designer agent for contract, then api-engineer for models

* [ ] **Task 2: Create Workout History Response Models**
  - Description: Create models for paginated workout history and detailed session views
  - User Story: As a developer, I want structured response models for workout history
  - Dependencies: Task 1
  - Estimated Effort: 1 hour
  - Acceptance Criteria:
    - WorkoutHistoryResponseModel with summary statistics
    - PaginatedWorkoutResponse for listing sessions
    - WorkoutDetailResponseModel with nested sets data
  - Assigned To: api-engineer agent

#### API Endpoint Tasks
* [ ] **Task 3: Implement POST /api/v1/workouts Endpoint**
  - Description: Create endpoint to log new workout sessions with sets
  - User Story: As a user, I want to log my completed workouts with all set details
  - Dependencies: Tasks 1, 2
  - Estimated Effort: 4 hours
  - Acceptance Criteria:
    - Accept workout session data with nested sets array
    - Validate plan_id if provided (must exist and belong to user)
    - Persist session and all sets in transaction
    - Calculate and store volume_load for each set
    - Return 201 with created session including all sets
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent, then backend-engineer for implementation

* [ ] **Task 4: Implement GET /api/v1/workouts Endpoint**
  - Description: Create endpoint to retrieve paginated workout history
  - User Story: As a user, I want to view my workout history with filtering options
  - Dependencies: Task 2
  - Estimated Effort: 3 hours
  - Acceptance Criteria:
    - Support pagination (page, per_page parameters)
    - Optional filtering by date range (start_date, end_date)
    - Optional filtering by plan_id
    - Return sessions with basic info (no nested sets)
    - Include summary statistics (total sessions, volume, etc.)
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent

* [ ] **Task 5: Implement GET /api/v1/workouts/{workout_id} Endpoint**
  - Description: Create endpoint to retrieve detailed workout session with all sets
  - User Story: As a user, I want to view complete details of a specific workout
  - Dependencies: Task 2
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Return full session details including all sets
    - Include exercise details for each set
    - Calculate session totals (total volume, duration, exercises)
    - Return 404 if session not found or not owned by user
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent

* [ ] **Task 6: Implement DELETE /api/v1/workouts/{workout_id} Endpoint**
  - Description: Create endpoint to delete workout sessions
  - User Story: As a user, I want to delete incorrectly logged workouts
  - Dependencies: None
  - Estimated Effort: 1 hour
  - Acceptance Criteria:
    - Hard delete workout session and cascade to sets
    - Verify ownership before deletion
    - Return 204 No Content on success
    - Return 404 if not found or not authorized
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent

#### Business Logic Tasks
* [ ] **Task 7: Implement Workout Repository**
  - Description: Create repository layer for workout data access
  - User Story: As a developer, I want clean data access patterns for workouts
  - Dependencies: Tasks 1, 2
  - Estimated Effort: 3 hours
  - Acceptance Criteria:
    - Create WorkoutRepository protocol with interface methods
    - Implement SupabaseWorkoutRepository with all CRUD operations
    - Support transaction handling for session+sets creation
    - Include efficient queries with proper indexing
  - Assigned To: database-architect agent

* [ ] **Task 8: Implement Workout Metrics Calculator**
  - Description: Create service to calculate workout metrics and statistics
  - User Story: As a user, I want to see my workout volume and progress metrics
  - Dependencies: Task 7
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Calculate total volume (sum of weight × reps)
    - Calculate workout duration from timestamps
    - Track unique exercises performed
    - Generate weekly/monthly volume trends
    - Support comparison with previous sessions
  - Assigned To: backend-engineer agent

* [ ] **Task 9: Implement Plan-Workout Association Logic**
  - Description: Handle relationship between workout sessions and training plans
  - User Story: As a user, I want my plan-based workouts linked to the plan template
  - Dependencies: Task 7
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Validate plan exists and is accessible to user
    - Track plan completion percentage
    - Handle ad-hoc workouts (null plan_id)
    - Maintain referential integrity with soft-deleted plans
  - Assigned To: backend-engineer agent

#### Testing Tasks
* [ ] **Task 10: Create Comprehensive Workout API Tests**
  - Description: Write test suite for all workout endpoints
  - User Story: As a developer, I want confidence that workout features work correctly
  - Dependencies: Tasks 3-6
  - Estimated Effort: 4 hours
  - Acceptance Criteria:
    - Test all CRUD operations with valid/invalid data
    - Test authentication and authorization scenarios
    - Test edge cases (empty sets, invalid exercises, etc.)
    - Mock repository layer for fast, isolated tests
    - Achieve minimum 80% code coverage
  - Assigned To: python-test-engineer agent

* [ ] **Task 11: Create Integration Tests for Workout Flow**
  - Description: Test complete workout logging flow end-to-end
  - User Story: As a developer, I want to verify the complete workout flow works
  - Dependencies: Tasks 3-9
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Test plan creation → workout logging → history retrieval flow
    - Test transaction rollback on partial failures
    - Test concurrent workout session handling
    - Verify cascade deletes work correctly
  - Assigned To: python-test-engineer agent

#### Documentation Tasks
* [ ] **Task 12: Finalize OpenAPI Contract & Documentation**
  - Description: Verify final OpenAPI contract and publish to frontend
  - User Story: As a developer, I want accurate API documentation as single source of truth
  - Dependencies: Tasks 3-6
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Run `uv run poe generate-openapi` for final schema
    - Run `uv run poe verify-openapi` to ensure consistency
    - Publish contract with `uv run poe publish-openapi`
    - Update docs/02_api_documentation.md with workout section
    - Ensure all examples in OpenAPI match test fixtures
    - Document error codes and validation rules
    - Include workout metrics calculation formulas
  - Assigned To: Sprint manager for tracking, auto-generated from code

### **IN PROGRESS**

* **Currently Working On:** [Move active task here when sprint begins]

### **DONE**

* [x] **Sprint 3 Completed:** All Plan CRUD endpoints implemented with 89% test coverage

## **Technical Considerations**

### Data Model Design
- **Workout Sessions**: Store date, plan_id (nullable), user_id, notes, RPE, wellness metrics
- **Sets**: Store exercise_id, weight, reps, rest_period, tempo, RIR, form_quality
- **Calculated Fields**: volume_load = weight × reps (stored as GENERATED column)
- **Relationships**: Sessions → Sets (1:M), Sets → Exercises (M:1)

### API Design Patterns
- **Contract-First Development**: OpenAPI contract defined before implementation
- **Nested Creation**: POST /workouts accepts session with nested sets array
- **Atomic Operations**: All sets created in single transaction with session
- **Pagination**: Consistent with Sprint 3 patterns (page, per_page, total)
- **Filtering**: Query parameters for date ranges and plan filtering
- **OpenAPI Verification**: Run `uv run poe verify-openapi` after each endpoint

### Repository Pattern Implementation
- **Protocol Definition**: WorkoutRepository abstract interface
- **DI Integration**: Register in src/core/di.py
- **Thin Repository**: Return raw dicts, let endpoints handle validation
- **Transaction Support**: Use Supabase transactions for multi-table operations

### Performance Considerations
- **Index Usage**: Leverage existing indexes on user_id, created_at
- **Query Optimization**: Use single query with joins for session+sets retrieval
- **Pagination Limits**: Default 20, max 100 items per page
- **Volume Calculations**: Use database GENERATED columns where possible

### Testing Strategy
- **Mock Repository**: Create mock_workout_repo fixture in conftest.py
- **Isolated Tests**: Mock dependencies to avoid database calls
- **Comprehensive Coverage**: Test happy path, validation, auth, and edge cases
- **Performance Tests**: Verify pagination and filtering efficiency

## **Success Criteria**

1. **Functional Requirements**:
   - Users can log complete workout sessions with multiple sets
   - Both plan-based and ad-hoc workouts are supported
   - Workout history is retrievable with filtering and pagination
   - Individual workout details show all sets and exercises
   - Workouts can be deleted if logged incorrectly

2. **Technical Requirements**:
   - OpenAPI contract is defined first and drives implementation
   - All endpoints follow RESTful conventions
   - Authentication required for all operations
   - Minimum 80% test coverage maintained
   - Repository pattern consistently applied
   - OpenAPI documentation verified with no drift from implementation
   - Contract published to frontend for type generation

3. **Data Integrity**:
   - Cascade deletes maintain referential integrity
   - Transactions ensure atomic session+sets creation
   - Plan associations validated before persistence
   - Volume calculations accurate and consistent

## **Dependencies and Prerequisites**

### From Previous Sprints
- ✅ **Sprint 2**: workout_sessions and sets tables created with proper schema
- ✅ **Sprint 2**: JWT authentication system fully operational
- ✅ **Sprint 3**: Plans endpoints completed (needed for plan validation)
- ✅ **Sprint 3**: Repository pattern and DI established

### External Dependencies
- PostgreSQL database with existing schema
- Supabase client for data operations
- Valid exercises in database for set logging

### Will Enable
- **Sprint 5**: Exercise library can show usage statistics
- **Sprint 6**: AI can reference workout history in conversations
- **Sprint 7**: Affinity system can track workout consistency
- **Frontend**: Complete workout logging UI implementation

## **Risk Mitigation**

| Risk | Impact | Mitigation Strategy |
|------|--------|-------------------|
| Complex nested data validation | Medium | Use Pydantic's nested model validation |
| Transaction failures with multiple sets | High | Implement proper rollback handling |
| Performance with large workout histories | Medium | Implement efficient pagination and indexing |
| Plan-workout association complexity | Low | Clear validation rules and error messages |

## **Notes & Blockers**

* **[Date]:** Sprint planning notes and decisions will be logged here
* **Blockers:** Any impediments discovered during implementation
* **AI Assistant Log:** Complex implementation sessions documented for reference

## **Definition of Done**

A task is considered complete when:
1. Code implementation meets all acceptance criteria
2. Unit tests written and passing with adequate coverage
3. Endpoint documented in OpenAPI specification
4. Code passes all quality checks (lint, format, typecheck)
5. Changes committed with descriptive message
6. Sprint documentation updated with completion status

---

*Sprint Created: February 9, 2025*
*Target Completion: February 16, 2025*
*Next Sprint: Sprint 5 - Exercise Library (February 17-23, 2025)*