# **Sprint 4: Workout Logging**

Sprint Duration: February 10, 2025 - February 16, 2025
Primary Goal: Implement workout session persistence and logging functionality, enabling users to track their training progress with both plan-based and ad-hoc workouts.

**Sprint Status: IN PROGRESS (40%)**
- API Endpoint Tasks: 2/4 PARTIAL (POST and GET list endpoints need field updates)
- Data Model Tasks: 3/3 COMPLETED ✅ (All models updated with powerbuilding features)
- Business Logic Tasks: 0/5 TODO (repository and services pending)
- Testing Tasks: 0/2 TODO
- Documentation Tasks: 0/1 TODO
- Total Tasks: 5/15 (33% complete) + 5 high-priority fixes completed = 40% overall progress

## **Sprint Objectives**

1. Enable users to log complete workout sessions with detailed set tracking
2. Support both plan-based workouts (following a pre-defined plan) and ad-hoc workouts
3. Provide comprehensive workout history retrieval with filtering and pagination
4. Calculate and persist workout metrics (volume, duration, RPE)
5. Maintain data integrity with proper relationships between sessions, sets, and exercises

## **Tasks**

This board follows the "Rule of One": Only one item should be in the "IN PROGRESS" section at any time.

### **TODO**

#### Data Model Tasks
* [x] **Task 1: Refine Workout Session Models (COMPLETED - 2025-02-10)**
  - Description: Update existing models to align with database schema and powerbuilding requirements
  - User Story: As a serious athlete, I need comprehensive workout tracking with all performance metrics
  - Dependencies: None
  - Estimated Effort: 4 hours (increased due to expanded scope)
  - Current Status: Initial models created but missing critical fields
  - Critical Gaps to Address:
    - Add workout_type field (strength/hypertrophy/power/endurance/mixed/technique/deload)
    - Add training_phase field (accumulation/intensification/realization/deload/testing)
    - Rename wellness fields: mood → mood_before/mood_after for clarity
    - Add pre_workout_energy and post_workout_energy (1-10 scale)
    - Add total_volume and total_sets calculated fields
    - Ensure started_at/completed_at timestamps properly handled
  - Acceptance Criteria:
    - WorkoutSessionCreateModel includes all training context fields
    - WorkoutSessionResponseModel exposes periodization tracking
    - Models support both quick logging and detailed tracking
    - Backward compatibility maintained with existing endpoints
    - Run `uv run poe generate-openapi` to verify contract
  - Assigned To: api-engineer agent for model updates

* [x] **Task 2: Refine Set Models (COMPLETED - 2025-02-10)**
  - Description: Update existing set models to expose all database capabilities
  - User Story: As a powerbuilder, I need detailed set tracking for progressive overload
  - Dependencies: Task 1
  - Estimated Effort: 3 hours (increased due to field additions)
  - Current Status: Basic models exist but missing powerbuilding-critical fields
  - Critical Gaps to Address:
    - Add set_type field (working/warmup/backoff/drop/cluster/rest_pause/amrap)
    - Add set_number for proper ordering within exercises
    - Add intensity_percentage (0-200% for overload work)
    - Fix form_quality to use 1-5 integer scale (not 4-point enum)
    - Add reached_failure boolean and failure_type enum
    - Add estimated_1rm field for strength tracking
    - Add equipment_variation and assistance_type fields
    - Add tempo notation field (e.g., "3-1-2-1")
    - Add range_of_motion_quality enum
  - Acceptance Criteria:
    - SetCreateModel includes all performance tracking fields
    - SetResponseModel includes calculated metrics
    - Form quality uses correct 1-5 integer scale
    - Set types properly differentiated for volume calculations
    - All database fields exposed through API
    - Backward compatibility maintained
  - Assigned To: api-engineer agent

* [x] **Task 2a: Create Enhanced Response Models (COMPLETED - 2025-02-10)**
  - Description: Create comprehensive response models for workout history with proper metrics
  - User Story: As an athlete, I want to see effective volume and progression metrics
  - Dependencies: Tasks 1, 2
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - WorkoutHistoryResponseModel includes working_volume vs total_volume
    - PaginatedWorkoutResponse shows training phase and workout type
    - WorkoutDetailResponseModel properly groups sets by exercise with ordering
    - WorkoutMetricsModel calculates effective volume (working sets only)
    - Include weekly/monthly volume trends in summary statistics
  - Assigned To: api-engineer agent

#### API Endpoint Tasks
* [~] **Task 3: Update POST /api/v1/workouts Endpoint (PARTIAL - Needs Field Updates)**
  - Description: Enhance existing endpoint to support all powerbuilding fields
  - User Story: As a powerbuilder, I want to log detailed workout data including set types and intensity
  - Dependencies: Tasks 1, 2
  - Estimated Effort: 4 hours
  - Current Status: Basic endpoint exists but missing critical fields
  - Required Updates:
    - Accept all new session fields (workout_type, training_phase, energy levels)
    - Accept all new set fields (set_type, intensity_percentage, failure tracking)
    - Validate form_quality as 1-5 integer (not enum)
    - Calculate effective_volume (working sets only) vs total_volume
    - Properly order sets by set_number within exercises
    - Support tempo notation and ROM quality
  - Acceptance Criteria:
    - Accept workout session data with all advanced fields
    - Validate plan_id if provided (must exist and belong to user)
    - Persist session and all sets in transaction
    - Calculate both total and effective volume
    - Return 201 with complete session data
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent, then backend-engineer for implementation

* [~] **Task 4: Update GET /api/v1/workouts Endpoint (PARTIAL - Needs Enhanced Metrics)**
  - Description: Enhance endpoint to include powerbuilding-specific metrics
  - User Story: As an athlete, I want to see both total and effective volume in my history
  - Dependencies: Task 2a
  - Estimated Effort: 3 hours
  - Current Status: Basic endpoint exists but missing advanced metrics
  - Required Updates:
    - Include workout_type and training_phase in response
    - Add effective_volume vs total_volume metrics
    - Show working_sets_count vs total_sets_count
    - Add filtering by workout_type and training_phase
    - Include average intensity percentage in summary
  - Acceptance Criteria:
    - Support pagination (page, per_page parameters)
    - Optional filtering by date range, plan_id, workout_type, training_phase
    - Return sessions with all training context fields
    - Include comprehensive statistics (total vs effective volume)
    - Show progression trends for volume and intensity
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent

* [ ] **Task 5: Implement GET /api/v1/workouts/{workout_id} Endpoint**
  - Description: Create endpoint to retrieve detailed workout session with all sets
  - User Story: As a user, I want to view complete details of a specific workout
  - Dependencies: Task 2
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Return full session details including all sets
    - Include exercise details for each set
    - Calculate session totals (total volume, duration, exercises)
    - Return 404 if session not found or not owned by user
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent

* [ ] **Task 6: Implement DELETE /api/v1/workouts/{workout_id} Endpoint**
  - Description: Create endpoint to delete workout sessions
  - User Story: As a user, I want to delete incorrectly logged workouts
  - Dependencies: None
  - Estimated Effort: 1 hour
  - Acceptance Criteria:
    - Hard delete workout session and cascade to sets
    - Verify ownership before deletion
    - Return 204 No Content on success
    - Return 404 if not found or not authorized
    - Verify OpenAPI contract matches implementation
    - Run `uv run poe verify-openapi` after implementation
  - Assigned To: api-engineer agent

#### Business Logic Tasks
* [ ] **Task 7: Implement Enhanced Workout Repository**
  - Description: Create repository layer for workout data access
  - User Story: As a developer, I want clean data access patterns for workouts
  - Dependencies: Tasks 1, 2
  - Estimated Effort: 3 hours
  - Acceptance Criteria:
    - Create WorkoutRepository protocol with interface methods
    - Implement SupabaseWorkoutRepository with all CRUD operations
    - Support transaction handling for session+sets creation
    - Include efficient queries with proper indexing
  - Assigned To: database-architect agent

* [ ] **Task 8: Implement Advanced Metrics Calculator**
  - Description: Create service to calculate comprehensive workout metrics for powerbuilding
  - User Story: As a powerbuilder, I want to track both volume and intensity metrics
  - Dependencies: Task 7
  - Estimated Effort: 3 hours (increased for additional calculations)
  - Acceptance Criteria:
    - Calculate total_volume vs effective_volume (working sets only)
    - Separate warm-up volume from working set volume
    - Calculate average intensity percentage per session
    - Track volume by movement pattern (push/pull/legs)
    - Calculate estimated 1RM progression over time
    - Generate tonnage metrics (total weight moved)
    - Support RPE-based autoregulation tracking
    - Compare volume/intensity with previous similar sessions
  - Assigned To: backend-engineer agent

* [ ] **Task 9: Implement Plan-Workout Association Logic**
  - Description: Handle relationship between workout sessions and training plans
  - User Story: As a user, I want my plan-based workouts linked to the plan template
  - Dependencies: Task 7
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Validate plan exists and is accessible to user
    - Track plan completion percentage
    - Handle ad-hoc workouts (null plan_id)
    - Maintain referential integrity with soft-deleted plans
    - Track adherence to planned intensity percentages
    - Compare actual vs planned volume
  - Assigned To: backend-engineer agent

* [ ] **Task 9a: Implement Set Ordering and Validation**
  - Description: Ensure proper set ordering and validate training parameters
  - User Story: As an athlete, I want my sets properly ordered and validated
  - Dependencies: Task 7
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Enforce set_number ordering within each exercise
    - Validate intensity_percentage against estimated 1RM
    - Ensure warm-up sets precede working sets
    - Validate form_quality on 1-5 scale
    - Check RIR/RPE consistency
    - Prevent duplicate set_numbers for same exercise
  - Assigned To: backend-engineer agent

#### Testing Tasks
* [ ] **Task 10: Create Comprehensive Workout API Tests**
  - Description: Write test suite for all workout endpoints
  - User Story: As a developer, I want confidence that workout features work correctly
  - Dependencies: Tasks 3-6
  - Estimated Effort: 4 hours
  - Acceptance Criteria:
    - Test all CRUD operations with valid/invalid data
    - Test authentication and authorization scenarios
    - Test edge cases (empty sets, invalid exercises, etc.)
    - Mock repository layer for fast, isolated tests
    - Achieve minimum 80% code coverage
  - Assigned To: python-test-engineer agent

* [ ] **Task 11: Create Integration Tests for Workout Flow**
  - Description: Test complete workout logging flow end-to-end
  - User Story: As a developer, I want to verify the complete workout flow works
  - Dependencies: Tasks 3-9
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Test plan creation → workout logging → history retrieval flow
    - Test transaction rollback on partial failures
    - Test concurrent workout session handling
    - Verify cascade deletes work correctly
  - Assigned To: python-test-engineer agent

#### Documentation Tasks
* [ ] **Task 12: Finalize OpenAPI Contract & Documentation**
  - Description: Verify final OpenAPI contract and publish to frontend
  - User Story: As a developer, I want accurate API documentation as single source of truth
  - Dependencies: Tasks 3-6
  - Estimated Effort: 2 hours
  - Acceptance Criteria:
    - Run `uv run poe generate-openapi` for final schema
    - Run `uv run poe verify-openapi` to ensure consistency
    - Publish contract with `uv run poe publish-openapi`
    - Update docs/02_api_documentation.md with workout section
    - Ensure all examples in OpenAPI match test fixtures
    - Document error codes and validation rules
    - Include workout metrics calculation formulas
  - Assigned To: Sprint manager for tracking, auto-generated from code

### **IN PROGRESS**

* **Currently Working On:** Task 3 - Update POST /api/v1/workouts Endpoint (Awaiting repository implementation)

### **DONE**

* [x] **Sprint 3 Completed:** All Plan CRUD endpoints implemented with 89% test coverage
* [x] **Task 1: Refine Workout Session Models** (Completed 2025-02-10)
  - Added WorkoutType and TrainingPhase enums for periodization tracking
  - Fixed wellness field naming, added pre/post workout energy tracking
  - Aligned all field names with database schema
* [x] **Task 2: Refine Set Models** (Completed 2025-02-10)
  - CRITICAL FIX: Changed form_quality from enum to 1-5 integer scale
  - Added SetType enum for proper volume calculations
  - Added intensity_percentage, failure tracking, and estimated_1rm fields
* [x] **Task 2a: Create Enhanced Response Models** (Completed 2025-02-10)
  - Created WorkoutMetricsModel with effective vs total volume separation
  - Added volume trends and movement pattern distribution
  - Enhanced history models with powerbuilding-specific metrics
* [x] **High Priority Fixes** (Completed 2025-02-10)
  - Added ValidationError handling to all workout endpoints
  - Consolidated PaginatedResponse to common module
  - Updated Sprint text from Sprint 3 to Sprint 4
  - Implemented 501 status for unimplemented endpoints
  - Added mock_workouts_repo fixture for testing

## **Technical Considerations**

### Data Model Design (Updated with Critical Fields)
- **Workout Sessions**: 
  - Core: user_id, plan_id (nullable), started_at, completed_at
  - Training Context: workout_type, training_phase, overall_rpe
  - Wellness: mood, pre_workout_energy, post_workout_energy
  - Metrics: total_volume, total_sets (calculated)
- **Sets**: 
  - Core: exercise_id, set_number, weight, reps
  - Classification: set_type (working/warmup/etc), intensity_percentage
  - Performance: rest_taken_seconds, tempo, rpe, reps_in_reserve
  - Quality: form_quality (1-5 scale), range_of_motion_quality
  - Advanced: reached_failure, failure_type, estimated_1rm
  - Context: equipment_variation, assistance_type
- **Calculated Fields**: 
  - volume_load = weight × reps (GENERATED column)
  - effective_volume = sum(volume_load) WHERE set_type = 'working'
- **Relationships**: Sessions → Sets (1:M), Sets → Exercises (M:1)

### API Design Patterns
- **Contract-First Development**: OpenAPI contract defined before implementation
- **Nested Creation**: POST /workouts accepts session with nested sets array
- **Atomic Operations**: All sets created in single transaction with session
- **Pagination**: Consistent with Sprint 3 patterns (page, per_page, total)
- **Filtering**: Query parameters for date ranges and plan filtering
- **OpenAPI Verification**: Run `uv run poe verify-openapi` after each endpoint

### Repository Pattern Implementation
- **Protocol Definition**: WorkoutRepository abstract interface
- **DI Integration**: Register in src/core/di.py
- **Thin Repository**: Return raw dicts, let endpoints handle validation
- **Transaction Support**: Use Supabase transactions for multi-table operations

### Performance Considerations
- **Index Usage**: Leverage existing indexes on user_id, created_at, set_type
- **Query Optimization**: Use single query with joins for session+sets retrieval
- **Pagination Limits**: Default 20, max 100 items per page
- **Volume Calculations**: 
  - Use database GENERATED columns for volume_load
  - Calculate effective_volume in application layer (working sets only)
  - Cache calculated metrics in workout_sessions table
- **Set Ordering**: Use set_number for consistent ordering within exercises

### Testing Strategy
- **Mock Repository**: Create mock_workout_repo fixture in conftest.py
- **Isolated Tests**: Mock dependencies to avoid database calls
- **Comprehensive Coverage**: Test happy path, validation, auth, and edge cases
- **Performance Tests**: Verify pagination and filtering efficiency

## **Success Criteria**

1. **Functional Requirements**:
   - Users can log complete workout sessions with multiple sets
   - Both plan-based and ad-hoc workouts are supported
   - Workout history is retrievable with filtering and pagination
   - Individual workout details show all sets and exercises
   - Workouts can be deleted if logged incorrectly

2. **Technical Requirements**:
   - OpenAPI contract is defined first and drives implementation
   - All endpoints follow RESTful conventions
   - Authentication required for all operations
   - Minimum 80% test coverage maintained
   - Repository pattern consistently applied
   - OpenAPI documentation verified with no drift from implementation
   - Contract published to frontend for type generation

3. **Data Integrity**:
   - Cascade deletes maintain referential integrity
   - Transactions ensure atomic session+sets creation
   - Plan associations validated before persistence
   - Volume calculations accurate and consistent

## **Dependencies and Prerequisites**

### From Previous Sprints
- ✅ **Sprint 2**: workout_sessions and sets tables created with proper schema
- ✅ **Sprint 2**: JWT authentication system fully operational
- ✅ **Sprint 3**: Plans endpoints completed (needed for plan validation)
- ✅ **Sprint 3**: Repository pattern and DI established

### External Dependencies
- PostgreSQL database with existing schema
- Supabase client for data operations
- Valid exercises in database for set logging

### Will Enable
- **Sprint 5**: Exercise library can show usage statistics
- **Sprint 6**: AI can reference workout history in conversations
- **Sprint 7**: Affinity system can track workout consistency
- **Frontend**: Complete workout logging UI implementation

## **Risk Mitigation**

| Risk | Impact | Mitigation Strategy |
|------|--------|-------------------|
| Complex nested data validation | Medium | Use Pydantic's nested model validation |
| Transaction failures with multiple sets | High | Implement proper rollback handling |
| Performance with large workout histories | Medium | Implement efficient pagination and indexing |
| Plan-workout association complexity | Low | Clear validation rules and error messages |
| Form quality scale mismatch | High | Ensure API uses 1-5 integer matching database |
| Missing critical training fields | High | Add all fields before MVP release |
| Volume calculation accuracy | Medium | Separate warm-up from working set calculations |

## **Notes & Blockers**

* **[2025-02-10 Morning]:** Sprint scope expanded based on powerbuilding-trainer agent review
* **[2025-02-10 Morning]:** Initial implementation had critical gaps for serious athletes (all now resolved):
  - ✅ Form quality using wrong scale - FIXED: Now uses 1-5 integer scale
  - ✅ Missing set_type field - FIXED: Added SetType enum with 7 types
  - ✅ Missing intensity_percentage - FIXED: Added with 0-200% range
  - ✅ Missing workout_type and training_phase - FIXED: Added comprehensive enums
  - ✅ Wellness field naming inconsistencies - FIXED: Aligned with database
* **[2025-02-10 Afternoon]:** All critical gaps addressed through orchestrated implementation:
  - Tasks 1, 2, 2a completed with powerbuilding-specific enhancements
  - High-priority fixes from external feedback all implemented
  - Code quality validated (mypy, ruff, black all passing)
  - OpenAPI schema expanded from 18 to 24 schemas
* **[2025-02-10 Evening]:** Sprint status at 40% completion:
  - Data model tasks: 100% complete (3/3)
  - API endpoint tasks: Need repository implementation before proceeding
  - Next priority: Task 7 (Workout Repository) to unblock endpoints
* **AI Assistant Log:** 
  - powerbuilding-trainer agent provided expert domain guidance
  - python-backend-engineer agent executed flawless implementation
  - code-reviewer validated production readiness (B+ grade)

## **Definition of Done**

A task is considered complete when:
1. Code implementation meets all acceptance criteria
2. Unit tests written and passing with adequate coverage
3. Endpoint documented in OpenAPI specification
4. Code passes all quality checks (lint, format, typecheck)
5. Changes committed with descriptive message
6. Sprint documentation updated with completion status

---

*Sprint Created: February 9, 2025*
*Target Completion: February 16, 2025*
*Next Sprint: Sprint 5 - Exercise Library (February 17-23, 2025)*